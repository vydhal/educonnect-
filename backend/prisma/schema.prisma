// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String     @id @default(cuid())
  email     String     @unique
  password  String
  name      String
  role      String     @default("ALUNO") // PROFESSOR, ALUNO, ESCOLA, COMUNIDADE, ADMIN
  avatar    String?
  bio       String?
  school    String?
  verified  Boolean    @default(false)
  
  // School Specific Fields
  inep      String?
  address   String?
  zone      String?    // 'URBANA' | 'RURAL'
  phone     String?
  schoolType String?   // 'ESCOLA' | 'CRECHE' | 'CMEI'

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relations
  posts     Post[]
  comments  Comment[]
  likes     Like[]
  followers UserFollow[] @relation("following")
  following UserFollow[] @relation("follower")
  projects  Project[]
  moderationItems ModerationItem[]
 
  // Social interactions
  badgesGiven    Badge[] @relation("badgeGiver")
  badgesReceived Badge[] @relation("badgeReceiver")
  viewsObserved  ProfileView[] @relation("viewer")
  profileViews   ProfileView[] @relation("profileOwner")
  testimonialsSent     Testimonial[] @relation("testimonialSender")
  testimonialsReceived Testimonial[] @relation("testimonialReceiver")
 
  // School-Teacher Relation
  schoolId  String?
  worksAt   User?   @relation("SchoolTeachers", fields: [schoolId], references: [id])
  teachers  User[]  @relation("SchoolTeachers")
}

model UserFollow {
  id          String @id @default(cuid())
  followerId  String
  follower    User   @relation("follower", fields: [followerId], references: [id], onDelete: Cascade)
  followingId String
  following   User   @relation("following", fields: [followingId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@unique([followerId, followingId])
}

model Post {
  id        String     @id @default(cuid())
  content   String
  image     String?   // Deprecated, keeping for backward compatibility
  images    String[]  // New: Support for multiple images (Gallery)
  authorId  String
  author    User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  tags      String[]   @default([])
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relations
  comments  Comment[]
  likes     Like[]
  moderation ModerationItem?
}

model WeeklyEvent {
  id        String   @id @default(cuid())
  name      String
  date      DateTime
  link      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Like {
  id        String   @id @default(cuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   @default("LIKE") // LIKE, LOVE, CLAP, ROCKET, IDEA
  createdAt DateTime @default(now())

  @@unique([postId, userId])
}

model ModerationItem {
  id        String   @id @default(cuid())
  postId    String   @unique
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  moderatorId String?
  moderator User?    @relation(fields: [moderatorId], references: [id], onDelete: SetNull)
  status    String   @default("PENDENTE") // PENDENTE, APROVADO, REPROVADO
  reason    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Project {
  id          String   @id @default(cuid())
  title       String
  description String
  image       String?
  authorId    String
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  category    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SystemSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}

model Badge {
  id          String   @id @default(cuid())
  type        String   // 'PROATIVO' | 'ESPECIAL' | 'HARMONIOSO'
  giverId     String
  giver       User     @relation("badgeGiver", fields: [giverId], references: [id], onDelete: Cascade)
  receiverId  String
  receiver    User     @relation("badgeReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@unique([giverId, receiverId, type])
}

model ProfileView {
  id          String   @id @default(cuid())
  viewerId    String
  viewer      User     @relation("viewer", fields: [viewerId], references: [id], onDelete: Cascade)
  profileId   String
  owner       User     @relation("profileOwner", fields: [profileId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@index([profileId])
}

model Testimonial {
  id          String   @id @default(cuid())
  content     String
  senderId    String
  sender      User     @relation("testimonialSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId  String
  receiver    User     @relation("testimonialReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([receiverId])
}
